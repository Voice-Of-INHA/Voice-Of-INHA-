<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <title>실시간 STT 테스트</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 720px;
            margin: 24px auto;
        }

        #log {
            white-space: pre-wrap;
            border: 1px solid #ccc;
            padding: 12px;
            min-height: 160px;
        }

        button {
            margin-right: 8px;
        }
    </style>
</head>

<body>
    <h1>실시간 STT (브라우저 마이크 → WebSocket)</h1>
    <p>
        <button id="btnStart">녹음 시작</button>
        <button id="btnStop" disabled>녹음 종료</button>
    </p>
    <div id="log"></div>

    <script>
        const logEl = document.getElementById('log');
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');

        let audioCtx;
        let processor;
        let ws;

        function log(line) {
            logEl.textContent += line + "\n";
            logEl.scrollTop = logEl.scrollHeight;
        }

        btnStart.onclick = async () => {
            try {
                // 1) 마이크 권한 요청
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // 2) WebSocket 연결
                ws = new WebSocket("ws://127.0.0.1:8000/ws/stt");

                ws.onopen = () => log("WS 연결됨");
                ws.onclose = () => log("WS 종료");
                ws.onerror = (e) => log("WS 에러: " + e.message);
                ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        if (msg.type === "stt_update") {
                            const tag = msg.is_final ? "[final]" : "[interim]";
                            log(`${tag} ${msg.transcript}`);
                            // 위험도 결과가 붙어오면 표시
                            if (msg.is_final && msg.risk) {
                                const r = msg.risk;
                                log(" → RISK:", `${r.risk_level}(${r.risk_score})`, r.labels?.join(", ") || "");
                                if (r.evidence?.length) log("    evidence:", r.evidence.join(" | "));
                                if (r.actions?.length) log("    actions :", r.actions.join(" / "));
                            }
                        } else if (msg.type === "error") {
                            log("[error] " + msg.message);
                        } else {
                            log("[msg] " + e.data);
                        }
                    } catch {
                        log("[raw] " + e.data);
                    }
                };

                // 3) AudioContext로 16kHz PCM16 생성해서 WS로 전송
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                const source = audioCtx.createMediaStreamSource(stream);
                const processor = audioCtx.createScriptProcessor(4096, 1, 1);

                processor.onaudioprocess = (e) => {
                    if (ws && ws.readyState === 1) {
                        const input = e.inputBuffer.getChannelData(0);
                        const pcm16 = new Int16Array(input.length);
                        for (let i = 0; i < input.length; i++) {
                            pcm16[i] = Math.max(-32768, Math.min(32767, input[i] * 32768));
                        }
                        ws.send(pcm16.buffer);
                    }
                };

                source.connect(processor);
                processor.connect(audioCtx.destination);
                btnStart.disabled = true;
                btnStop.disabled = false;
                log("녹음 시작");
            } catch (err) {
                console.error(err);
                log("시작 실패: " + err);
            }
        };

        btnStop.onclick = () => {
            try {
                if (mediaRecorder && mediaRecorder.state !== "inactive") {
                    mediaRecorder.stop();
                    log("녹음 중지");
                }
                if (ws && ws.readyState === 1) {
                    ws.send("EOS"); // 서버에 종료 신호
                    ws.close(1000, "done");
                }
            } catch (err) {
                console.error(err);
            } finally {
                btnStart.disabled = false;
                btnStop.disabled = true;
            }
        };
    </script>
</body>

</html>